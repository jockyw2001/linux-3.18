#include <linux/module.h>
#include <linux/moduleparam.h>

#include <linux/cdev.h>
#include <sound/core.h>
#include <sound/pcm.h>
#include <sound/soc.h>
#include <sound/soc-dapm.h>

#include <linux/of.h>
//#include <linux/of_address.h>
#include <linux/of_irq.h>
#include <linux/delay.h>
//#include "ms_platform.h"
#include "drv_audio_io.h"
#include "drv_audio_types.h"
//#include "hal_audio_types.h"
#include "drv_audio.h"
#include "drv_audio_dbg.h"
#include "mhal_audio.h"
#include "ms_msys.h"

#define AUDIO_IN_DEV 3
#define AUDIO_OUT_DEV 4
#define AUDIO_DEV (AUDIO_IN_DEV+AUDIO_OUT_DEV)

#define MIU_OFFSET 0x20000000

#if 1
u8 tone_48k[] =
{
    0x00, 0x00, 0x00, 0x00, 0x5F, 0x08, 0x60, 0x08, 0x9B, 0x10, 0x9A, 0x10, 0x8D, 0x18, 0x8C, 0x18,
    0x13, 0x20, 0x13, 0x20, 0x0D, 0x27, 0x0D, 0x27, 0x5C, 0x2D, 0x5D, 0x2D, 0xE5, 0x32, 0xE4, 0x32,
    0x8F, 0x37, 0x8E, 0x37, 0x44, 0x3B, 0x44, 0x3B, 0xF7, 0x3D, 0xF7, 0x3D, 0x9A, 0x3F, 0x99, 0x3F,
    0x27, 0x40, 0x26, 0x40, 0x9A, 0x3F, 0x99, 0x3F, 0xF6, 0x3D, 0xF7, 0x3D, 0x45, 0x3B, 0x44, 0x3B,
    0x8F, 0x37, 0x8E, 0x37, 0xE5, 0x32, 0xE5, 0x32, 0x5C, 0x2D, 0x5D, 0x2D, 0x0E, 0x27, 0x0D, 0x27,
    0x13, 0x20, 0x13, 0x20, 0x8C, 0x18, 0x8D, 0x18, 0x9A, 0x10, 0x9B, 0x10, 0x60, 0x08, 0x60, 0x08,
    0x00, 0x00, 0x00, 0x00, 0xA1, 0xF7, 0xA1, 0xF7, 0x66, 0xEF, 0x65, 0xEF, 0x73, 0xE7, 0x73, 0xE7,
    0xED, 0xDF, 0xEC, 0xDF, 0xF3, 0xD8, 0xF4, 0xD8, 0xA3, 0xD2, 0xA3, 0xD2, 0x1B, 0xCD, 0x1B, 0xCD,
    0x71, 0xC8, 0x72, 0xC8, 0xBC, 0xC4, 0xBC, 0xC4, 0x09, 0xC2, 0x09, 0xC2, 0x66, 0xC0, 0x66, 0xC0,
    0xD9, 0xBF, 0xDA, 0xBF, 0x66, 0xC0, 0x66, 0xC0, 0x09, 0xC2, 0x09, 0xC2, 0xBB, 0xC4, 0xBC, 0xC4,
    0x72, 0xC8, 0x71, 0xC8, 0x1B, 0xCD, 0x1C, 0xCD, 0xA4, 0xD2, 0xA3, 0xD2, 0xF2, 0xD8, 0xF3, 0xD8,
    0xEC, 0xDF, 0xED, 0xDF, 0x73, 0xE7, 0x74, 0xE7, 0x66, 0xEF, 0x66, 0xEF, 0xA1, 0xF7, 0xA1, 0xF7,
    0x00, 0x00, 0x00, 0x00, 0x5F, 0x08, 0x60, 0x08, 0x9B, 0x10, 0x9A, 0x10, 0x8D, 0x18, 0x8C, 0x18,
    0x13, 0x20, 0x13, 0x20, 0x0D, 0x27, 0x0D, 0x27, 0x5C, 0x2D, 0x5D, 0x2D, 0xE5, 0x32, 0xE4, 0x32,
    0x8F, 0x37, 0x8E, 0x37, 0x44, 0x3B, 0x44, 0x3B, 0xF7, 0x3D, 0xF7, 0x3D, 0x9A, 0x3F, 0x99, 0x3F,
    0x27, 0x40, 0x26, 0x40, 0x9A, 0x3F, 0x99, 0x3F, 0xF6, 0x3D, 0xF7, 0x3D, 0x45, 0x3B, 0x44, 0x3B,
    0x8F, 0x37, 0x8E, 0x37, 0xE5, 0x32, 0xE5, 0x32, 0x5C, 0x2D, 0x5D, 0x2D, 0x0E, 0x27, 0x0D, 0x27,
    0x13, 0x20, 0x13, 0x20, 0x8C, 0x18, 0x8D, 0x18, 0x9A, 0x10, 0x9B, 0x10, 0x60, 0x08, 0x60, 0x08,
    0x00, 0x00, 0x00, 0x00, 0xA1, 0xF7, 0xA1, 0xF7, 0x66, 0xEF, 0x65, 0xEF, 0x73, 0xE7, 0x73, 0xE7,
    0xED, 0xDF, 0xEC, 0xDF, 0xF3, 0xD8, 0xF4, 0xD8, 0xA3, 0xD2, 0xA3, 0xD2, 0x1B, 0xCD, 0x1B, 0xCD,
    0x71, 0xC8, 0x72, 0xC8, 0xBC, 0xC4, 0xBC, 0xC4, 0x09, 0xC2, 0x09, 0xC2, 0x66, 0xC0, 0x66, 0xC0,
    0xD9, 0xBF, 0xDA, 0xBF, 0x66, 0xC0, 0x66, 0xC0, 0x09, 0xC2, 0x09, 0xC2, 0xBB, 0xC4, 0xBC, 0xC4,
    0x72, 0xC8, 0x71, 0xC8, 0x1B, 0xCD, 0x1C, 0xCD, 0xA4, 0xD2, 0xA3, 0xD2, 0xF2, 0xD8, 0xF3, 0xD8,
    0xEC, 0xDF, 0xED, 0xDF, 0x73, 0xE7, 0x74, 0xE7, 0x66, 0xEF, 0x66, 0xEF, 0xA1, 0xF7, 0xA1, 0xF7,
    0x00, 0x00, 0x00, 0x00, 0x5F, 0x08, 0x60, 0x08, 0x9B, 0x10, 0x9A, 0x10, 0x8D, 0x18, 0x8C, 0x18,
    0x13, 0x20, 0x13, 0x20, 0x0D, 0x27, 0x0D, 0x27, 0x5C, 0x2D, 0x5D, 0x2D, 0xE5, 0x32, 0xE4, 0x32,
    0x8F, 0x37, 0x8E, 0x37, 0x44, 0x3B, 0x44, 0x3B, 0xF7, 0x3D, 0xF7, 0x3D, 0x9A, 0x3F, 0x99, 0x3F,
    0x27, 0x40, 0x26, 0x40, 0x9A, 0x3F, 0x99, 0x3F, 0xF6, 0x3D, 0xF7, 0x3D, 0x45, 0x3B, 0x44, 0x3B,
    0x8F, 0x37, 0x8E, 0x37, 0xE5, 0x32, 0xE5, 0x32, 0x5C, 0x2D, 0x5D, 0x2D, 0x0E, 0x27, 0x0D, 0x27,
    0x13, 0x20, 0x13, 0x20, 0x8C, 0x18, 0x8D, 0x18, 0x9A, 0x10, 0x9B, 0x10, 0x60, 0x08, 0x60, 0x08,
    0x00, 0x00, 0x00, 0x00, 0xA1, 0xF7, 0xA1, 0xF7, 0x66, 0xEF, 0x65, 0xEF, 0x73, 0xE7, 0x73, 0xE7,
    0xED, 0xDF, 0xEC, 0xDF, 0xF3, 0xD8, 0xF4, 0xD8, 0xA3, 0xD2, 0xA3, 0xD2, 0x1B, 0xCD, 0x1B, 0xCD,
    0x71, 0xC8, 0x72, 0xC8, 0xBC, 0xC4, 0xBC, 0xC4, 0x09, 0xC2, 0x09, 0xC2, 0x66, 0xC0, 0x66, 0xC0,
    0xD9, 0xBF, 0xDA, 0xBF, 0x66, 0xC0, 0x66, 0xC0, 0x09, 0xC2, 0x09, 0xC2, 0xBB, 0xC4, 0xBC, 0xC4,
    0x72, 0xC8, 0x71, 0xC8, 0x1B, 0xCD, 0x1C, 0xCD, 0xA4, 0xD2, 0xA3, 0xD2, 0xF2, 0xD8, 0xF3, 0xD8,
    0xEC, 0xDF, 0xED, 0xDF, 0x73, 0xE7, 0x74, 0xE7, 0x66, 0xEF, 0x66, 0xEF, 0xA1, 0xF7, 0xA1, 0xF7,
    0x00, 0x00, 0x00, 0x00, 0x5F, 0x08, 0x60, 0x08, 0x9B, 0x10, 0x9A, 0x10, 0x8D, 0x18, 0x8C, 0x18,
    0x13, 0x20, 0x13, 0x20, 0x0D, 0x27, 0x0D, 0x27, 0x5C, 0x2D, 0x5D, 0x2D, 0xE5, 0x32, 0xE4, 0x32,
    0x8F, 0x37, 0x8E, 0x37, 0x44, 0x3B, 0x44, 0x3B, 0xF7, 0x3D, 0xF7, 0x3D, 0x9A, 0x3F, 0x99, 0x3F,
    0x27, 0x40, 0x26, 0x40, 0x9A, 0x3F, 0x99, 0x3F, 0xF6, 0x3D, 0xF7, 0x3D, 0x45, 0x3B, 0x44, 0x3B,
    0x8F, 0x37, 0x8E, 0x37, 0xE5, 0x32, 0xE5, 0x32, 0x5C, 0x2D, 0x5D, 0x2D, 0x0E, 0x27, 0x0D, 0x27,
    0x13, 0x20, 0x13, 0x20, 0x8C, 0x18, 0x8D, 0x18, 0x9A, 0x10, 0x9B, 0x10, 0x60, 0x08, 0x60, 0x08,
    0x00, 0x00, 0x00, 0x00, 0xA1, 0xF7, 0xA1, 0xF7, 0x66, 0xEF, 0x65, 0xEF, 0x73, 0xE7, 0x73, 0xE7,
    0xED, 0xDF, 0xEC, 0xDF, 0xF3, 0xD8, 0xF4, 0xD8, 0xA3, 0xD2, 0xA3, 0xD2, 0x1B, 0xCD, 0x1B, 0xCD,
    0x71, 0xC8, 0x72, 0xC8, 0xBC, 0xC4, 0xBC, 0xC4, 0x09, 0xC2, 0x09, 0xC2, 0x66, 0xC0, 0x66, 0xC0,
    0xD9, 0xBF, 0xDA, 0xBF, 0x66, 0xC0, 0x66, 0xC0, 0x09, 0xC2, 0x09, 0xC2, 0xBB, 0xC4, 0xBC, 0xC4,
    0x72, 0xC8, 0x71, 0xC8, 0x1B, 0xCD, 0x1C, 0xCD, 0xA4, 0xD2, 0xA3, 0xD2, 0xF2, 0xD8, 0xF3, 0xD8,
    0xEC, 0xDF, 0xED, 0xDF, 0x73, 0xE7, 0x74, 0xE7, 0x66, 0xEF, 0x66, 0xEF, 0xA1, 0xF7, 0xA1, 0xF7,
    0x00, 0x00, 0x00, 0x00, 0x5F, 0x08, 0x60, 0x08, 0x9B, 0x10, 0x9A, 0x10, 0x8D, 0x18, 0x8C, 0x18,
    0x13, 0x20, 0x13, 0x20, 0x0D, 0x27, 0x0D, 0x27, 0x5C, 0x2D, 0x5D, 0x2D, 0xE5, 0x32, 0xE4, 0x32,
    0x8F, 0x37, 0x8E, 0x37, 0x44, 0x3B, 0x44, 0x3B, 0xF7, 0x3D, 0xF7, 0x3D, 0x9A, 0x3F, 0x99, 0x3F,
    0x27, 0x40, 0x26, 0x40, 0x9A, 0x3F, 0x99, 0x3F, 0xF6, 0x3D, 0xF7, 0x3D, 0x45, 0x3B, 0x44, 0x3B,
    0x8F, 0x37, 0x8E, 0x37, 0xE5, 0x32, 0xE5, 0x32, 0x5C, 0x2D, 0x5D, 0x2D, 0x0E, 0x27, 0x0D, 0x27,
    0x13, 0x20, 0x13, 0x20, 0x8C, 0x18, 0x8D, 0x18, 0x9A, 0x10, 0x9B, 0x10, 0x60, 0x08, 0x60, 0x08,
    0x00, 0x00, 0x00, 0x00, 0xA1, 0xF7, 0xA1, 0xF7, 0x66, 0xEF, 0x65, 0xEF, 0x73, 0xE7, 0x73, 0xE7,
    0xED, 0xDF, 0xEC, 0xDF, 0xF3, 0xD8, 0xF4, 0xD8, 0xA3, 0xD2, 0xA3, 0xD2, 0x1B, 0xCD, 0x1B, 0xCD,
    0x71, 0xC8, 0x72, 0xC8, 0xBC, 0xC4, 0xBC, 0xC4, 0x09, 0xC2, 0x09, 0xC2, 0x66, 0xC0, 0x66, 0xC0,
    0xD9, 0xBF, 0xDA, 0xBF, 0x66, 0xC0, 0x66, 0xC0, 0x09, 0xC2, 0x09, 0xC2, 0xBB, 0xC4, 0xBC, 0xC4,
    0x72, 0xC8, 0x71, 0xC8, 0x1B, 0xCD, 0x1C, 0xCD, 0xA4, 0xD2, 0xA3, 0xD2, 0xF2, 0xD8, 0xF3, 0xD8,
    0xEC, 0xDF, 0xED, 0xDF, 0x73, 0xE7, 0x74, 0xE7, 0x66, 0xEF, 0x66, 0xEF, 0xA1, 0xF7, 0xA1, 0xF7,
    0x00, 0x00, 0x00, 0x00, 0x5F, 0x08, 0x60, 0x08, 0x9B, 0x10, 0x9A, 0x10, 0x8D, 0x18, 0x8C, 0x18,
    0x13, 0x20, 0x13, 0x20, 0x0D, 0x27, 0x0D, 0x27, 0x5C, 0x2D, 0x5D, 0x2D, 0xE5, 0x32, 0xE4, 0x32,
    0x8F, 0x37, 0x8E, 0x37, 0x44, 0x3B, 0x44, 0x3B, 0xF7, 0x3D, 0xF7, 0x3D, 0x9A, 0x3F, 0x99, 0x3F,
    0x27, 0x40, 0x26, 0x40, 0x9A, 0x3F, 0x99, 0x3F, 0xF6, 0x3D, 0xF7, 0x3D, 0x45, 0x3B, 0x44, 0x3B,
    0x8F, 0x37, 0x8E, 0x37, 0xE5, 0x32, 0xE5, 0x32, 0x5C, 0x2D, 0x5D, 0x2D, 0x0E, 0x27, 0x0D, 0x27,
    0x13, 0x20, 0x13, 0x20, 0x8C, 0x18, 0x8D, 0x18, 0x9A, 0x10, 0x9B, 0x10, 0x60, 0x08, 0x60, 0x08,
    0x00, 0x00, 0x00, 0x00, 0xA1, 0xF7, 0xA1, 0xF7, 0x66, 0xEF, 0x65, 0xEF, 0x73, 0xE7, 0x73, 0xE7,
    0xED, 0xDF, 0xEC, 0xDF, 0xF3, 0xD8, 0xF4, 0xD8, 0xA3, 0xD2, 0xA3, 0xD2, 0x1B, 0xCD, 0x1B, 0xCD,
    0x71, 0xC8, 0x72, 0xC8, 0xBC, 0xC4, 0xBC, 0xC4, 0x09, 0xC2, 0x09, 0xC2, 0x66, 0xC0, 0x66, 0xC0,
    0xD9, 0xBF, 0xDA, 0xBF, 0x66, 0xC0, 0x66, 0xC0, 0x09, 0xC2, 0x09, 0xC2, 0xBB, 0xC4, 0xBC, 0xC4,
    0x72, 0xC8, 0x71, 0xC8, 0x1B, 0xCD, 0x1C, 0xCD, 0xA4, 0xD2, 0xA3, 0xD2, 0xF2, 0xD8, 0xF3, 0xD8,
    0xEC, 0xDF, 0xED, 0xDF, 0x73, 0xE7, 0x74, 0xE7, 0x66, 0xEF, 0x66, 0xEF, 0xA1, 0xF7, 0xA1, 0xF7,
    0x00, 0x00, 0x00, 0x00, 0x5F, 0x08, 0x60, 0x08, 0x9B, 0x10, 0x9A, 0x10, 0x8D, 0x18, 0x8C, 0x18,
    0x13, 0x20, 0x13, 0x20, 0x0D, 0x27, 0x0D, 0x27, 0x5C, 0x2D, 0x5D, 0x2D, 0xE5, 0x32, 0xE4, 0x32,
    0x8F, 0x37, 0x8E, 0x37, 0x44, 0x3B, 0x44, 0x3B, 0xF7, 0x3D, 0xF7, 0x3D, 0x9A, 0x3F, 0x99, 0x3F,
    0x27, 0x40, 0x26, 0x40, 0x9A, 0x3F, 0x99, 0x3F, 0xF6, 0x3D, 0xF7, 0x3D, 0x45, 0x3B, 0x44, 0x3B,
    0x8F, 0x37, 0x8E, 0x37, 0xE5, 0x32, 0xE5, 0x32, 0x5C, 0x2D, 0x5D, 0x2D, 0x0E, 0x27, 0x0D, 0x27,
    0x13, 0x20, 0x13, 0x20, 0x8C, 0x18, 0x8D, 0x18, 0x9A, 0x10, 0x9B, 0x10, 0x60, 0x08, 0x60, 0x08,
    0x00, 0x00, 0x00, 0x00, 0xA1, 0xF7, 0xA1, 0xF7, 0x66, 0xEF, 0x65, 0xEF, 0x73, 0xE7, 0x73, 0xE7,
    0xED, 0xDF, 0xEC, 0xDF, 0xF3, 0xD8, 0xF4, 0xD8, 0xA3, 0xD2, 0xA3, 0xD2, 0x1B, 0xCD, 0x1B, 0xCD,
    0x71, 0xC8, 0x72, 0xC8, 0xBC, 0xC4, 0xBC, 0xC4, 0x09, 0xC2, 0x09, 0xC2, 0x66, 0xC0, 0x66, 0xC0,
    0xD9, 0xBF, 0xDA, 0xBF, 0x66, 0xC0, 0x66, 0xC0, 0x09, 0xC2, 0x09, 0xC2, 0xBB, 0xC4, 0xBC, 0xC4,
    0x72, 0xC8, 0x71, 0xC8, 0x1B, 0xCD, 0x1C, 0xCD, 0xA4, 0xD2, 0xA3, 0xD2, 0xF2, 0xD8, 0xF3, 0xD8,
    0xEC, 0xDF, 0xED, 0xDF, 0x73, 0xE7, 0x74, 0xE7, 0x66, 0xEF, 0x66, 0xEF, 0xA1, 0xF7, 0xA1, 0xF7,
    0x00, 0x00, 0x00, 0x00, 0x5F, 0x08, 0x60, 0x08, 0x9B, 0x10, 0x9A, 0x10, 0x8D, 0x18, 0x8C, 0x18,
    0x13, 0x20, 0x13, 0x20, 0x0D, 0x27, 0x0D, 0x27, 0x5C, 0x2D, 0x5D, 0x2D, 0xE5, 0x32, 0xE4, 0x32,
    0x8F, 0x37, 0x8E, 0x37, 0x44, 0x3B, 0x44, 0x3B, 0xF7, 0x3D, 0xF7, 0x3D, 0x9A, 0x3F, 0x99, 0x3F,
    0x27, 0x40, 0x26, 0x40, 0x9A, 0x3F, 0x99, 0x3F, 0xF6, 0x3D, 0xF7, 0x3D, 0x45, 0x3B, 0x44, 0x3B,
    0x8F, 0x37, 0x8E, 0x37, 0xE5, 0x32, 0xE5, 0x32, 0x5C, 0x2D, 0x5D, 0x2D, 0x0E, 0x27, 0x0D, 0x27,
    0x13, 0x20, 0x13, 0x20, 0x8C, 0x18, 0x8D, 0x18, 0x9A, 0x10, 0x9B, 0x10, 0x60, 0x08, 0x60, 0x08,
    0x00, 0x00, 0x00, 0x00, 0xA1, 0xF7, 0xA1, 0xF7, 0x66, 0xEF, 0x65, 0xEF, 0x73, 0xE7, 0x73, 0xE7,
    0xED, 0xDF, 0xEC, 0xDF, 0xF3, 0xD8, 0xF4, 0xD8, 0xA3, 0xD2, 0xA3, 0xD2, 0x1B, 0xCD, 0x1B, 0xCD,
    0x71, 0xC8, 0x72, 0xC8, 0xBC, 0xC4, 0xBC, 0xC4, 0x09, 0xC2, 0x09, 0xC2, 0x66, 0xC0, 0x66, 0xC0,
    0xD9, 0xBF, 0xDA, 0xBF, 0x66, 0xC0, 0x66, 0xC0, 0x09, 0xC2, 0x09, 0xC2, 0xBB, 0xC4, 0xBC, 0xC4,
    0x72, 0xC8, 0x71, 0xC8, 0x1B, 0xCD, 0x1C, 0xCD, 0xA4, 0xD2, 0xA3, 0xD2, 0xF2, 0xD8, 0xF3, 0xD8,
    0xEC, 0xDF, 0xED, 0xDF, 0x73, 0xE7, 0x74, 0xE7, 0x66, 0xEF, 0x66, 0xEF, 0xA1, 0xF7, 0xA1, 0xF7,
    0x00, 0x00, 0x00, 0x00, 0x5F, 0x08, 0x60, 0x08, 0x9B, 0x10, 0x9A, 0x10, 0x8D, 0x18, 0x8C, 0x18,
    0x13, 0x20, 0x13, 0x20, 0x0D, 0x27, 0x0D, 0x27, 0x5C, 0x2D, 0x5D, 0x2D, 0xE5, 0x32, 0xE4, 0x32,
    0x8F, 0x37, 0x8E, 0x37, 0x44, 0x3B, 0x44, 0x3B, 0xF7, 0x3D, 0xF7, 0x3D, 0x9A, 0x3F, 0x99, 0x3F,
    0x27, 0x40, 0x26, 0x40, 0x9A, 0x3F, 0x99, 0x3F, 0xF6, 0x3D, 0xF7, 0x3D, 0x45, 0x3B, 0x44, 0x3B,
    0x8F, 0x37, 0x8E, 0x37, 0xE5, 0x32, 0xE5, 0x32, 0x5C, 0x2D, 0x5D, 0x2D, 0x0E, 0x27, 0x0D, 0x27,
    0x13, 0x20, 0x13, 0x20, 0x8C, 0x18, 0x8D, 0x18, 0x9A, 0x10, 0x9B, 0x10, 0x60, 0x08, 0x60, 0x08,
    0x00, 0x00, 0x00, 0x00, 0xA1, 0xF7, 0xA1, 0xF7, 0x66, 0xEF, 0x65, 0xEF, 0x73, 0xE7, 0x73, 0xE7,
    0xED, 0xDF, 0xEC, 0xDF, 0xF3, 0xD8, 0xF4, 0xD8, 0xA3, 0xD2, 0xA3, 0xD2, 0x1B, 0xCD, 0x1B, 0xCD,
    0x71, 0xC8, 0x72, 0xC8, 0xBC, 0xC4, 0xBC, 0xC4, 0x09, 0xC2, 0x09, 0xC2, 0x66, 0xC0, 0x66, 0xC0,
    0xD9, 0xBF, 0xDA, 0xBF, 0x66, 0xC0, 0x66, 0xC0, 0x09, 0xC2, 0x09, 0xC2, 0xBB, 0xC4, 0xBC, 0xC4,
    0x72, 0xC8, 0x71, 0xC8, 0x1B, 0xCD, 0x1C, 0xCD, 0xA4, 0xD2, 0xA3, 0xD2, 0xF2, 0xD8, 0xF3, 0xD8,
    0xEC, 0xDF, 0xED, 0xDF, 0x73, 0xE7, 0x74, 0xE7, 0x66, 0xEF, 0x66, 0xEF, 0xA1, 0xF7, 0xA1, 0xF7,
    0x00, 0x00, 0x00, 0x00, 0x5F, 0x08, 0x60, 0x08, 0x9B, 0x10, 0x9A, 0x10, 0x8D, 0x18, 0x8C, 0x18,
    0x13, 0x20, 0x13, 0x20, 0x0D, 0x27, 0x0D, 0x27, 0x5C, 0x2D, 0x5D, 0x2D, 0xE5, 0x32, 0xE4, 0x32,
    0x8F, 0x37, 0x8E, 0x37, 0x44, 0x3B, 0x44, 0x3B, 0xF7, 0x3D, 0xF7, 0x3D, 0x9A, 0x3F, 0x99, 0x3F,
    0x27, 0x40, 0x26, 0x40, 0x9A, 0x3F, 0x99, 0x3F, 0xF6, 0x3D, 0xF7, 0x3D, 0x45, 0x3B, 0x44, 0x3B,
    0x8F, 0x37, 0x8E, 0x37, 0xE5, 0x32, 0xE5, 0x32, 0x5C, 0x2D, 0x5D, 0x2D, 0x0E, 0x27, 0x0D, 0x27,
    0x13, 0x20, 0x13, 0x20, 0x8C, 0x18, 0x8D, 0x18, 0x9A, 0x10, 0x9B, 0x10, 0x60, 0x08, 0x60, 0x08,
    0x00, 0x00, 0x00, 0x00, 0xA1, 0xF7, 0xA1, 0xF7, 0x66, 0xEF, 0x65, 0xEF, 0x73, 0xE7, 0x73, 0xE7,
    0xED, 0xDF, 0xEC, 0xDF, 0xF3, 0xD8, 0xF4, 0xD8, 0xA3, 0xD2, 0xA3, 0xD2, 0x1B, 0xCD, 0x1B, 0xCD,
    0x71, 0xC8, 0x72, 0xC8, 0xBC, 0xC4, 0xBC, 0xC4, 0x09, 0xC2, 0x09, 0xC2, 0x66, 0xC0, 0x66, 0xC0,
    0xD9, 0xBF, 0xDA, 0xBF, 0x66, 0xC0, 0x66, 0xC0, 0x09, 0xC2, 0x09, 0xC2, 0xBB, 0xC4, 0xBC, 0xC4,
    0x72, 0xC8, 0x71, 0xC8, 0x1B, 0xCD, 0x1C, 0xCD, 0xA4, 0xD2, 0xA3, 0xD2, 0xF2, 0xD8, 0xF3, 0xD8,
    0xEC, 0xDF, 0xED, 0xDF, 0x73, 0xE7, 0x74, 0xE7, 0x66, 0xEF, 0x66, 0xEF, 0xA1, 0xF7, 0xA1, 0xF7
};


static u8 tone_48k_mono[] =
{
    0x00, 0x00, 0xf9, 0x18, 0xfb, 0x30, 0x1c, 0x47,
    0x82, 0x5a, 0x6d, 0x6a, 0x41, 0x76, 0x8a, 0x7d,
    0xff, 0x7f, 0x8b, 0x7d, 0x42, 0x76, 0x6f, 0x6a,
    0x84, 0x5a, 0x1f, 0x47, 0xfe, 0x30, 0xfc, 0x18,
    0x03, 0x00, 0x0a, 0xe7, 0x07, 0xcf, 0xe6, 0xb8,
    0x80, 0xa5, 0x95, 0x95, 0xc0, 0x89, 0x76, 0x82,
    0x00, 0x80, 0x75, 0x82, 0xbc, 0x89, 0x90, 0x95,
    0x7a, 0xa5, 0xde, 0xb8, 0xff, 0xce, 0x02, 0xe7,
    0x00, 0x00, 0xf9, 0x18, 0xfb, 0x30, 0x1c, 0x47,
    0x82, 0x5a, 0x6d, 0x6a, 0x41, 0x76, 0x8a, 0x7d,
    0xff, 0x7f, 0x8b, 0x7d, 0x42, 0x76, 0x6f, 0x6a,
    0x84, 0x5a, 0x1f, 0x47, 0xfe, 0x30, 0xfc, 0x18,
    0x03, 0x00, 0x0a, 0xe7, 0x07, 0xcf, 0xe6, 0xb8,
    0x80, 0xa5, 0x95, 0x95, 0xc0, 0x89, 0x76, 0x82,
    0x00, 0x80, 0x75, 0x82, 0xbc, 0x89, 0x90, 0x95,
    0x7a, 0xa5, 0xde, 0xb8, 0xff, 0xce, 0x02, 0xe7,
    0x00, 0x00, 0xf9, 0x18, 0xfb, 0x30, 0x1c, 0x47,
    0x82, 0x5a, 0x6d, 0x6a, 0x41, 0x76, 0x8a, 0x7d,
    0xff, 0x7f, 0x8b, 0x7d, 0x42, 0x76, 0x6f, 0x6a,
    0x84, 0x5a, 0x1f, 0x47, 0xfe, 0x30, 0xfc, 0x18,
    0x03, 0x00, 0x0a, 0xe7, 0x07, 0xcf, 0xe6, 0xb8,
    0x80, 0xa5, 0x95, 0x95, 0xc0, 0x89, 0x76, 0x82,
    0x00, 0x80, 0x75, 0x82, 0xbc, 0x89, 0x90, 0x95,
    0x7a, 0xa5, 0xde, 0xb8, 0xff, 0xce, 0x02, 0xe7,
    0x00, 0x00, 0xf9, 0x18, 0xfb, 0x30, 0x1c, 0x47,
    0x82, 0x5a, 0x6d, 0x6a, 0x41, 0x76, 0x8a, 0x7d,
    0xff, 0x7f, 0x8b, 0x7d, 0x42, 0x76, 0x6f, 0x6a,
    0x84, 0x5a, 0x1f, 0x47, 0xfe, 0x30, 0xfc, 0x18,
    0x03, 0x00, 0x0a, 0xe7, 0x07, 0xcf, 0xe6, 0xb8,
    0x80, 0xa5, 0x95, 0x95, 0xc0, 0x89, 0x76, 0x82,
    0x00, 0x80, 0x75, 0x82, 0xbc, 0x89, 0x90, 0x95,
    0x7a, 0xa5, 0xde, 0xb8, 0xff, 0xce, 0x02, 0xe7
};


static u8 tone_48k_noninterleave[] =
{
    0x00, 0x00, 0xf9, 0x18, 0xfb, 0x30, 0x1c, 0x47,
    0x82, 0x5a, 0x6d, 0x6a, 0x41, 0x76, 0x8a, 0x7d,
    0xff, 0x7f, 0x8b, 0x7d, 0x42, 0x76, 0x6f, 0x6a,
    0x84, 0x5a, 0x1f, 0x47, 0xfe, 0x30, 0xfc, 0x18,
    0x03, 0x00, 0x0a, 0xe7, 0x07, 0xcf, 0xe6, 0xb8,
    0x80, 0xa5, 0x95, 0x95, 0xc0, 0x89, 0x76, 0x82,
    0x00, 0x80, 0x75, 0x82, 0xbc, 0x89, 0x90, 0x95,
    0x7a, 0xa5, 0xde, 0xb8, 0xff, 0xce, 0x02, 0xe7,
    0x00, 0x00, 0xf9, 0x18, 0xfb, 0x30, 0x1c, 0x47,
    0x82, 0x5a, 0x6d, 0x6a, 0x41, 0x76, 0x8a, 0x7d,
    0xff, 0x7f, 0x8b, 0x7d, 0x42, 0x76, 0x6f, 0x6a,
    0x84, 0x5a, 0x1f, 0x47, 0xfe, 0x30, 0xfc, 0x18,
    0x03, 0x00, 0x0a, 0xe7, 0x07, 0xcf, 0xe6, 0xb8,
    0x80, 0xa5, 0x95, 0x95, 0xc0, 0x89, 0x76, 0x82,
    0x00, 0x80, 0x75, 0x82, 0xbc, 0x89, 0x90, 0x95,
    0x7a, 0xa5, 0xde, 0xb8, 0xff, 0xce, 0x02, 0xe7,
    0x00, 0x00, 0xf9, 0x18, 0xfb, 0x30, 0x1c, 0x47,
    0x82, 0x5a, 0x6d, 0x6a, 0x41, 0x76, 0x8a, 0x7d,
    0xff, 0x7f, 0x8b, 0x7d, 0x42, 0x76, 0x6f, 0x6a,
    0x84, 0x5a, 0x1f, 0x47, 0xfe, 0x30, 0xfc, 0x18,
    0x03, 0x00, 0x0a, 0xe7, 0x07, 0xcf, 0xe6, 0xb8,
    0x80, 0xa5, 0x95, 0x95, 0xc0, 0x89, 0x76, 0x82,
    0x00, 0x80, 0x75, 0x82, 0xbc, 0x89, 0x90, 0x95,
    0x7a, 0xa5, 0xde, 0xb8, 0xff, 0xce, 0x02, 0xe7,
    0x00, 0x00, 0xf9, 0x18, 0xfb, 0x30, 0x1c, 0x47,
    0x82, 0x5a, 0x6d, 0x6a, 0x41, 0x76, 0x8a, 0x7d,
    0xff, 0x7f, 0x8b, 0x7d, 0x42, 0x76, 0x6f, 0x6a,
    0x84, 0x5a, 0x1f, 0x47, 0xfe, 0x30, 0xfc, 0x18,
    0x03, 0x00, 0x0a, 0xe7, 0x07, 0xcf, 0xe6, 0xb8,
    0x80, 0xa5, 0x95, 0x95, 0xc0, 0x89, 0x76, 0x82,
    0x00, 0x80, 0x75, 0x82, 0xbc, 0x89, 0x90, 0x95,
    0x7a, 0xa5, 0xde, 0xb8, 0xff, 0xce, 0x02, 0xe7,
    0x00, 0x00, 0xf9, 0x18, 0xfb, 0x30, 0x1c, 0x47,
    0x82, 0x5a, 0x6d, 0x6a, 0x41, 0x76, 0x8a, 0x7d,
    0xff, 0x7f, 0x8b, 0x7d, 0x42, 0x76, 0x6f, 0x6a,
    0x84, 0x5a, 0x1f, 0x47, 0xfe, 0x30, 0xfc, 0x18,
    0x03, 0x00, 0x0a, 0xe7, 0x07, 0xcf, 0xe6, 0xb8,
    0x80, 0xa5, 0x95, 0x95, 0xc0, 0x89, 0x76, 0x82,
    0x00, 0x80, 0x75, 0x82, 0xbc, 0x89, 0x90, 0x95,
    0x7a, 0xa5, 0xde, 0xb8, 0xff, 0xce, 0x02, 0xe7,
    0x00, 0x00, 0xf9, 0x18, 0xfb, 0x30, 0x1c, 0x47,
    0x82, 0x5a, 0x6d, 0x6a, 0x41, 0x76, 0x8a, 0x7d,
    0xff, 0x7f, 0x8b, 0x7d, 0x42, 0x76, 0x6f, 0x6a,
    0x84, 0x5a, 0x1f, 0x47, 0xfe, 0x30, 0xfc, 0x18,
    0x03, 0x00, 0x0a, 0xe7, 0x07, 0xcf, 0xe6, 0xb8,
    0x80, 0xa5, 0x95, 0x95, 0xc0, 0x89, 0x76, 0x82,
    0x00, 0x80, 0x75, 0x82, 0xbc, 0x89, 0x90, 0x95,
    0x7a, 0xa5, 0xde, 0xb8, 0xff, 0xce, 0x02, 0xe7,
    0x00, 0x00, 0xf9, 0x18, 0xfb, 0x30, 0x1c, 0x47,
    0x82, 0x5a, 0x6d, 0x6a, 0x41, 0x76, 0x8a, 0x7d,
    0xff, 0x7f, 0x8b, 0x7d, 0x42, 0x76, 0x6f, 0x6a,
    0x84, 0x5a, 0x1f, 0x47, 0xfe, 0x30, 0xfc, 0x18,
    0x03, 0x00, 0x0a, 0xe7, 0x07, 0xcf, 0xe6, 0xb8,
    0x80, 0xa5, 0x95, 0x95, 0xc0, 0x89, 0x76, 0x82,
    0x00, 0x80, 0x75, 0x82, 0xbc, 0x89, 0x90, 0x95,
    0x7a, 0xa5, 0xde, 0xb8, 0xff, 0xce, 0x02, 0xe7,
    0x00, 0x00, 0xf9, 0x18, 0xfb, 0x30, 0x1c, 0x47,
    0x82, 0x5a, 0x6d, 0x6a, 0x41, 0x76, 0x8a, 0x7d,
    0xff, 0x7f, 0x8b, 0x7d, 0x42, 0x76, 0x6f, 0x6a,
    0x84, 0x5a, 0x1f, 0x47, 0xfe, 0x30, 0xfc, 0x18,
    0x03, 0x00, 0x0a, 0xe7, 0x07, 0xcf, 0xe6, 0xb8,
    0x80, 0xa5, 0x95, 0x95, 0xc0, 0x89, 0x76, 0x82,
    0x00, 0x80, 0x75, 0x82, 0xbc, 0x89, 0x90, 0x95,
    0x7a, 0xa5, 0xde, 0xb8, 0xff, 0xce, 0x02, 0xe7
};

#else
u8 tone_48k[]=
{
    0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F,
    0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F,
    0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F,
    0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F,
    0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F,
    0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F,
    0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F,
    0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F,
    0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F,
    0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F,
    0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F,
    0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F,
    0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F,
    0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F,
    0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F,
    0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F,
    0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F,
    0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F,
    0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F,
    0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F,
    0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F,
    0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F,
    0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F,
    0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F,
    0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F,
    0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F,
    0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F,
    0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F,
    0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F,
    0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F,
    0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F,
    0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F,
    0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F,
    0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F,
    0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F,
    0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F,
    0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F,
    0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F,
    0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F,
    0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F,
    0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F,
    0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F,
    0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F,
    0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F,
    0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F,
    0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F,
    0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F,
    0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F,
    0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F,
    0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F,
    0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F,
    0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F,
    0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F,
    0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F,
    0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F,
    0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F,
    0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F,
    0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F,
    0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F,
    0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F,
    0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F,
    0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F,
    0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F,
    0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F,
    0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F,
    0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F,
    0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F,
    0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F,
    0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F,
    0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F,
    0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F,
    0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F,
    0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F,
    0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F,
    0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F,
    0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F,
    0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F,
    0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F,
    0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F,
    0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F,
    0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F,
    0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F,
    0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F,
    0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F,
    0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F,
    0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F,
    0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F,
    0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F,
    0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F,
    0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F,
    0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F,
    0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F,
    0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F,
    0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F,
    0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F,
    0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F,
    0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F,
    0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F,
    0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F,
    0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0x7F,
};
#endif

struct pcm_hardware
{
    unsigned int rate_min;		/* min rate */
    unsigned int rate_max;		/* max rate */
    unsigned int channels_min;	/* min channels */
    unsigned int channels_max;	/* max channels */
    size_t buffer_bytes_max;	/* max buffer size */
    size_t period_bytes_min;	/* min period size */
    size_t period_bytes_max;	/* max period size */
    unsigned int periods_min;	/* min # of periods */
    unsigned int periods_max;	/* max # of periods */
};

struct pcm_data
{
    unsigned int dev_id;
    unsigned int playback;
    long(*DrvAudioIoctlParse)(struct file *filp, unsigned int u32Cmd, unsigned long u32Arg);
};

/*static struct pcm_hardware pcm_playback_hardware =
{
  .rate_min			= 8000,
  .rate_max			= 48000,
  .channels_min		= 1,
  .channels_max		= 2,
  .buffer_bytes_max	= 96 * 1024,
  .period_bytes_min	= 2 * 1024,
  .period_bytes_max	= 24 * 1024,
  .periods_min		= 4,
  .periods_max		= 8,
};*/


static void* alloc_dmem(const char* name, unsigned int size, dma_addr_t *addr)
{
    MSYS_DMEM_INFO dmem;
    memcpy(dmem.name,name,strlen(name)+1);
    dmem.length=size;
    if(0!=msys_request_dmem(&dmem))
    {
        return NULL;
    }
    *addr=dmem.phys;
    return (void *)((uintptr_t)dmem.kvirt);
}

static void free_dmem(const char* name, unsigned int size, void *virt, dma_addr_t addr)
{
    MSYS_DMEM_INFO dmem;
    memcpy(dmem.name,name,strlen(name)+1);
    dmem.length=size;
    dmem.kvirt=(unsigned long long)((uintptr_t)virt);
    dmem.phys=(unsigned long long)((uintptr_t)addr);
    msys_release_dmem(&dmem);
}

static void getDevAttr(int nMinor, int *pbPlay, int *pnDev)
{
    if(nMinor<AUDIO_IN_DEV)
    {
        *pbPlay = FALSE;
        *pnDev = nMinor;
    }
    else
    {
        *pbPlay = TRUE;
        *pnDev = nMinor-AUDIO_IN_DEV;
    }
}

struct dma_buffer
{
    unsigned char *area;	/* virtual pointer */
    dma_addr_t addr;	/* physical address */
    size_t bytes;		/* buffer size in bytes */
};
struct dma_buffer buf;

static long AudioCapIoctl(struct file *filp, unsigned int cmd, unsigned long arg)
{
    struct AUD_PcmCfg_s sPcmCfg;
    MHAL_AUDIO_PcmCfg_t tPcm;
    MHAL_AUDIO_I2sCfg_t tI2sCfg;
    struct pcm_data *pPcmData = (struct pcm_data *)filp->private_data;
    int dev = pPcmData->dev_id;
    int ret;
    u8 tmpBuf[2048];
    int count = 0;
    int size;
    int total_size;
    int i;
    int nSel;
    struct file **fw;
    mm_segment_t fs;
    char fn[50];

    switch(cmd)
    {
        case AUDRV_PCM_TEST:
        {
            if (copy_from_user(&sPcmCfg, (void __user *)arg,sizeof(sPcmCfg))!=0)
            {
                AUD_PRINTF(ERROR_LEVEL, "AUDRV_PCM_TEST arg error!!!\n");
                return -EFAULT;
            }
            else
            {

                AUD_PRINTF(TRACE_LEVEL, "AUDRV_PCM_TEST arg get!!!\n");
            }
#if 0
            int count = 0;
            struct file *f=NULL;
            // struct file *fw=NULL;
            char rbuf[2048];
            mm_segment_t fs;

            f = filp_open("/system/I2_unit_test/48k_1k.pcm", O_RDONLY,0);

            if(IS_ERR(f))
            {
                printk(KERN_ERR"Test: filp_open error!!.");
                return -1;
            }
            else
            {
                fs = get_fs();
            }
#endif
#if 0
            fw = filp_open("/system/I2_unit_test/48k_1k_dump.pcm", O_RDWR | O_APPEND | O_CREAT, 0644);

            if(IS_ERR(fw))
            {
                printk(KERN_ERR"Test: filp_open error!!.");
                return -1;
            }
#endif

            if(sPcmCfg.nInterleaved)
            {
                fw = (struct file**)kmalloc(sizeof(struct file*),GFP_KERNEL);
                sprintf(fn,"/tmp/rec_%d_%dch_%d.pcm",sPcmCfg.nRate,sPcmCfg.n16Channels,sPcmCfg.nBitWidth);
                *fw = filp_open(fn, O_RDWR | O_CREAT, 0644);

                if(IS_ERR(*fw))
                {
                    printk(KERN_ERR"Test: filp_open error!!.");
                    return -1;
                }

            }
            else
            {
                fw = (struct file**)kmalloc(sizeof(struct file*)*sPcmCfg.n16Channels,GFP_KERNEL);
                for(i=0;i<sPcmCfg.n16Channels;i++)
                {
                    sprintf(fn,"/tmp/rec_%d_ch%d_%d.pcm",sPcmCfg.nRate,i,sPcmCfg.nBitWidth);
                    *(fw+i) = filp_open(fn, O_RDWR | O_CREAT, 0644);

                    if(IS_ERR(*(fw+i)))
                    {
                        printk(KERN_ERR"Test: filp_open error!!.");
                        return -1;
                    }
                }
            }

            fs = get_fs();
            if(sPcmCfg.nRate==8000)
                tPcm.eRate = E_MHAL_AUDIO_RATE_8K;
            else if(sPcmCfg.nRate==16000)
                tPcm.eRate = E_MHAL_AUDIO_RATE_16K;
            else if(sPcmCfg.nRate==32000)
                tPcm.eRate = E_MHAL_AUDIO_RATE_32K;
            else if(sPcmCfg.nRate==48000)
                tPcm.eRate = E_MHAL_AUDIO_RATE_48K;
            else
            {
                AUD_PRINTF(ERROR_LEVEL, "AUDRV_PCM_IOCTL sample rate %d not support!!!\n",sPcmCfg.nRate);
                return -EFAULT;
            }

            if(sPcmCfg.nBitWidth==16)
                tPcm.eWidth = E_MHAL_AUDIO_BITWIDTH_16;
            else if(sPcmCfg.nBitWidth==24)
                tPcm.eWidth = E_MHAL_AUDIO_BITWIDTH_24;
            else if(sPcmCfg.nBitWidth==32)
                tPcm.eWidth = E_MHAL_AUDIO_BITWIDTH_32;
            else
            {
                AUD_PRINTF(ERROR_LEVEL, "AUDRV_PCM_IOCTL bitwidth %d not support!!!\n",sPcmCfg.nBitWidth);
                return -EFAULT;
            }
            tPcm.u16Channels = sPcmCfg.n16Channels;
            tPcm.bInterleaved = sPcmCfg.nInterleaved;
            tPcm.pu8DmaArea = buf.area;
            tPcm.phyDmaAddr = buf.addr-MIU_OFFSET;
            tPcm.u32BufferSize = buf.bytes;
            tPcm.u32PeriodSize = sPcmCfg.n32PeriodSize;//7680;//1024*2*2*6;
            tPcm.u32StartThres = sPcmCfg.n32StartThres;//buf.bytes+1;//buf.bytes/2;

            if(sPcmCfg.nI2sConfig)
            {
                if(sPcmCfg.sI2s.nTdmMode==1 && sPcmCfg.sI2s.nMsMode==0)
                {
                    tI2sCfg.eMode = E_MHAL_AUDIO_MODE_TDM_MASTER;
                }
                else if(sPcmCfg.sI2s.nTdmMode==0)
                {
                    if(sPcmCfg.sI2s.nMsMode==0)
                    {
                        tI2sCfg.eMode = E_MHAL_AUDIO_MODE_I2S_MASTER;
                    }
                    else
                    {
                        tI2sCfg.eMode = E_MHAL_AUDIO_MODE_I2S_SLAVE;
                    }
                }
                else
                {
                    AUD_PRINTF(ERROR_LEVEL, "AUDRV_PCM_IOCTL I2S mode not support!!!\n");
                    return -EFAULT;
                }

                tI2sCfg.eWidth = (sPcmCfg.sI2s.nBitWidth?E_MHAL_AUDIO_BITWIDTH_32:E_MHAL_AUDIO_BITWIDTH_16);

                tI2sCfg.eFmt = (sPcmCfg.sI2s.nFmt?E_MHAL_AUDIO_I2S_FMT_LEFT_JUSTIFY:E_MHAL_AUDIO_I2S_FMT_I2S);

                tI2sCfg.u16Channels = sPcmCfg.sI2s.u16Channels;

                ret=MHAL_AUDIO_ConfigI2sIn(dev, &tI2sCfg);
                if(ret)
                {
                    AUD_PRINTF(ERROR_LEVEL,"MHAL_AUDIO_ConfigI2sIn error=%d!!!\n",ret);
                    return -EFAULT;
                }
            }


            total_size = sPcmCfg.nTimeMs*(sPcmCfg.nRate/1000)*sPcmCfg.n16Channels*(sPcmCfg.nBitWidth/8);
            //AUD_PRINTF(ERROR_LEVEL, "test size %d!!!\n",total_size);
            printk(KERN_ERR"test size %d!!!\n",total_size);


            ret = MHAL_AUDIO_ConfigPcmIn(dev, &tPcm);
            if(ret)
            {
                AUD_PRINTF(ERROR_LEVEL, "MHAL_AUDIO_ConfigPcmIn error=%d!!!\n",ret);
                return -EFAULT;
            }
            ret = MHAL_AUDIO_OpenPcmIn(dev);
            if(ret)
            {
                AUD_PRINTF(ERROR_LEVEL, "MHAL_AUDIO_OpenPcmIn error=%d!!!\n",ret);
                goto fail;
            }
            ret = MHAL_AUDIO_StartPcmIn(dev);
            if(ret)
            {
                AUD_PRINTF(ERROR_LEVEL, "MHAL_AUDIO_StartPcmIn error=%d!!!\n",ret);
                goto fail;
            }
            while(count<total_size)
            {
                if(MHAL_AUDIO_IsPcmInXrun(dev))
                {
                    AUD_PRINTF(ERROR_LEVEL, "MHAL_AUDIO_StartPcmIn %d\n",count);
                    ret = MHAL_AUDIO_StartPcmIn(dev);
                    if(ret)
                    {
                        AUD_PRINTF(ERROR_LEVEL, "MHAL_AUDIO_StartPcmIn error=%d!!!\n",ret);
                        goto fail;
                    }
                    AUD_PRINTF(ERROR_LEVEL, "XRUN!!!!, count = %d\n",count);
                }
                //AUD_PRINTF(ERROR_LEVEL, "MHAL_AUDIO_ReadDataIn count = %d\n",count);

                ret = MHAL_AUDIO_ReadDataIn(dev, tmpBuf, sizeof(tmpBuf), TRUE);
                if(ret<0)
                {
                    AUD_PRINTF(ERROR_LEVEL, "read data fail!!!, ret = %d\n",ret);
                }
                else
                {
                    set_fs(get_ds());

                    if(sPcmCfg.nInterleaved)
                    {
                        set_fs(get_ds());
                        size = (*fw)->f_op->write((*fw), (char *)tmpBuf, ret, &(*fw)->f_pos);
                        set_fs(fs);
                        count += size;
                    }
                    else
                    {
                        set_fs(get_ds());

                        for(i=0;i<sPcmCfg.n16Channels;i++)
                        {
                            size = (*(fw+i))->f_op->write((*(fw+i)), (char *)tmpBuf+(ret/sPcmCfg.n16Channels)*i, ret/sPcmCfg.n16Channels, &(*(fw+i))->f_pos);
                            if(size!=ret/sPcmCfg.n16Channels)
                                AUD_PRINTF(ERROR_LEVEL, "wrong write length!!!,size %d, write = %d\n",size,ret/sPcmCfg.n16Channels);
                        }
                        set_fs(fs);
                        count += ret;
                    }

                }
            }
            //AUD_PRINTF(ERROR_LEVEL, "file ok %d bytes!!!\n",count);
            printk(KERN_ERR"file ok %d bytes!!!\n",count);
            if(sPcmCfg.nInterleaved)
            {
                filp_close((*fw), NULL);
                kfree(fw);
            }
            else
            {
                for(i=0;i<sPcmCfg.n16Channels;i++)
                {
                    filp_close(*(fw+i), NULL);
                }
                kfree(fw);
            }
fail:
            ret = MHAL_AUDIO_StopPcmIn(dev);
            if(ret)
            {
                AUD_PRINTF(ERROR_LEVEL, "MHAL_AUDIO_StopPcmIn error=%d!!!\n",ret);
                //return -EFAULT;
            }
            ret = MHAL_AUDIO_ClosePcmIn(dev);
            if(ret)
            {
                AUD_PRINTF(ERROR_LEVEL, "MHAL_AUDIO_ClosePcmIn error=%d!!!\n",ret);
                return -EFAULT;
            }

            break;
        }

        case AUDRV_ADC_MUX:
            if (get_user(nSel,(int __user *)arg))
                return -EFAULT;

            if(!DrvAudAdcSetMux((AudAdcPath_e)nSel))
                return -EFAULT;

            printk(KERN_ERR"ADC MUX %u!!!\n",nSel);
            break;
        case AUDRV_LINEIN_GAIN:
            if (get_user(nSel,(int __user *)arg))
                return -EFAULT;

            if(!DrvAudSetAdcGain(AUD_ADC_LINEIN,nSel))
                return -EFAULT;

            printk(KERN_ERR"Line In Gain %u!!!\n",nSel);
            break;
        case AUDRV_MIC_GAIN:
            if (get_user(nSel,(int __user *)arg))
                return -EFAULT;

            if(!DrvAudSetAdcGain(AUD_ADC_MICIN,nSel))
                return -EFAULT;

            printk(KERN_ERR"MIC In Gain %u!!!\n",nSel);
            break;
        case AUDRV_MICPRE_GAIN:
            if (get_user(nSel,(int __user *)arg))
                return -EFAULT;

            if(!DrvAudSetMicAmpGain(nSel))
                return -EFAULT;

            printk(KERN_ERR"MIC Pre Gain %u!!!\n",nSel);
            break;
        default:
            AUD_PRINTF(ERROR_LEVEL,"Unknown IOCTL Command 0x%08X\n", cmd);
            return -ENOTTY;
    }
    return 0;
}

static long AudioPlayIoctl(struct file *filp, unsigned int cmd, unsigned long arg)
{
    struct AUD_PcmCfg_s sPcmCfg;
    MHAL_AUDIO_PcmCfg_t tPcm;
    MHAL_AUDIO_I2sCfg_t tI2sCfg;
    struct pcm_data *pPcmData = (struct pcm_data *)filp->private_data;
    int dev = pPcmData->dev_id;
    int size = 0;
    int flag = 1;
    int i=0;
    int ret;
    int total_size = 0;
    u8 *pDataArray;
    int nArrSize;
    int nStartThres;

    switch(cmd)
    {
        case AUDRV_PCM_TEST:
        {
            if (copy_from_user(&sPcmCfg, (void __user *)arg,sizeof(sPcmCfg))!=0)
            {
                AUD_PRINTF(ERROR_LEVEL, "AUDRV_PCM_TEST arg error!!!\n");
                return -EFAULT;
            }
            else
            {

                AUD_PRINTF(TRACE_LEVEL, "AUDRV_PCM_TEST arg get!!!\n");
            }

            if(sPcmCfg.nRate==8000)
                tPcm.eRate = E_MHAL_AUDIO_RATE_8K;
            else if(sPcmCfg.nRate==16000)
                tPcm.eRate = E_MHAL_AUDIO_RATE_16K;
            else if(sPcmCfg.nRate==32000)
                tPcm.eRate = E_MHAL_AUDIO_RATE_32K;
            else if(sPcmCfg.nRate==48000)
                tPcm.eRate = E_MHAL_AUDIO_RATE_48K;
            else
            {
                AUD_PRINTF(ERROR_LEVEL, "AUDRV_PCM_IOCTL sample rate %d not support!!!\n",sPcmCfg.nRate);
                return -EFAULT;
            }

            if(sPcmCfg.nBitWidth==16)
                tPcm.eWidth = E_MHAL_AUDIO_BITWIDTH_16;
            else if(sPcmCfg.nBitWidth==24)
                tPcm.eWidth = E_MHAL_AUDIO_BITWIDTH_24;
            else if(sPcmCfg.nBitWidth==32)
                tPcm.eWidth = E_MHAL_AUDIO_BITWIDTH_32;
            else
            {
                AUD_PRINTF(ERROR_LEVEL, "AUDRV_PCM_IOCTL bitwidth %d not support!!!\n",sPcmCfg.nBitWidth);
                return -EFAULT;
            }

            if(sPcmCfg.n16Channels==1)
            {
                pDataArray = tone_48k_mono;
                nArrSize = sizeof(tone_48k_mono);
            }
            else if(sPcmCfg.n16Channels==2)
            {
                if(sPcmCfg.nInterleaved)
                {
                    pDataArray = tone_48k;
                    nArrSize = sizeof(tone_48k);
                }
                else
                {
                    pDataArray = tone_48k_noninterleave;
                    nArrSize = sizeof(tone_48k_noninterleave);
                }
            }
            else
            {
                AUD_PRINTF(ERROR_LEVEL, "AUDRV_PCM_IOCTL channel %d not support!!!\n",sPcmCfg.n16Channels);
                return -EFAULT;
            }


            tPcm.u16Channels = sPcmCfg.n16Channels;
            tPcm.bInterleaved = sPcmCfg.nInterleaved;
            tPcm.pu8DmaArea = buf.area;
            tPcm.phyDmaAddr = buf.addr-MIU_OFFSET;
            tPcm.u32BufferSize = buf.bytes;
            tPcm.u32PeriodSize = sPcmCfg.n32PeriodSize;//1024*2*2*6;
            tPcm.u32StartThres = sPcmCfg.n32StartThres;//buf.bytes+1;//buf.bytes/2;

            if(sPcmCfg.nI2sConfig)
            {
                if(sPcmCfg.sI2s.nTdmMode==1 && sPcmCfg.sI2s.nMsMode==0)
                {
                    tI2sCfg.eMode = E_MHAL_AUDIO_MODE_TDM_MASTER;
                }
                else if(sPcmCfg.sI2s.nTdmMode==0)
                {
                    if(sPcmCfg.sI2s.nMsMode==0)
                    {
                        tI2sCfg.eMode = E_MHAL_AUDIO_MODE_I2S_MASTER;
                    }
                    else
                    {
                        tI2sCfg.eMode = E_MHAL_AUDIO_MODE_I2S_SLAVE;
                    }
                }
                else
                {
                    AUD_PRINTF(ERROR_LEVEL, "AUDRV_PCM_IOCTL I2S mode not support!!!\n");
                    return -EFAULT;
                }

                tI2sCfg.eWidth = (sPcmCfg.sI2s.nBitWidth?E_MHAL_AUDIO_BITWIDTH_32:E_MHAL_AUDIO_BITWIDTH_16);

                tI2sCfg.eFmt = (sPcmCfg.sI2s.nFmt?E_MHAL_AUDIO_I2S_FMT_LEFT_JUSTIFY:E_MHAL_AUDIO_I2S_FMT_I2S);

                tI2sCfg.u16Channels = sPcmCfg.sI2s.u16Channels;

                ret=MHAL_AUDIO_ConfigI2sOut(dev, &tI2sCfg);
                if(ret)
                {
                    AUD_PRINTF(ERROR_LEVEL,"MHAL_AUDIO_ConfigI2sIn error=%d!!!\n",ret);
                    return -EFAULT;
                }
                else
                {
                    AUD_PRINTF(ERROR_LEVEL,"MHAL_AUDIO_I2S\n");
                }
            }
            total_size = sPcmCfg.nTimeMs*(sPcmCfg.nRate/1000)*sPcmCfg.n16Channels*(sPcmCfg.nBitWidth/8);
            //AUD_PRINTF(ERROR_LEVEL, "test size %d!!!\n",total_size);
            printk(KERN_ERR"test size %d!!!\n",total_size);

            if(sPcmCfg.n16Channels==1)
            {
                nStartThres = buf.bytes/2 - sPcmCfg.n32PeriodSize;
            }
            else
            {
                nStartThres = buf.bytes - sPcmCfg.n32PeriodSize;
            }

            //AUD_PRINTF(ERROR_LEVEL, "Start size %d\n",nStartThres);
            printk(KERN_ERR"Start size %d\n",nStartThres);

            ret = MHAL_AUDIO_ConfigPcmOut(dev, &tPcm);
            if(ret)
            {
                AUD_PRINTF(ERROR_LEVEL, "MHAL_AUDIO_ConfigPcmOut error=%d!!!\n",ret);
                return -EFAULT;
            }

            ret = MHAL_AUDIO_OpenPcmOut(dev);
            if(ret)
            {
                AUD_PRINTF(ERROR_LEVEL, "MHAL_AUDIO_OpenPcmOut error=%d!!!\n",ret);
                goto fail;
            }


            while(total_size>nArrSize)
            {
#if 0
                if(i==500)
                    MHAL_AUDIO_SetGainOut(dev,-10);
                else if(i==1000)
                    MHAL_AUDIO_SetGainOut(dev,-20);
                else if(i==1500)
                    MHAL_AUDIO_SetGainOut(dev,-30);
                else if(i==1600)
                    MHAL_AUDIO_SetGainOut(dev,-40);
                else if(i==1700)
                    MHAL_AUDIO_SetGainOut(dev,-50);
                else if(i==1800)
                    MHAL_AUDIO_SetGainOut(dev,-60);
                else if(i==2000)
                    MHAL_AUDIO_SetGainOut(dev,0);
                else if(i==2100)
                    MHAL_AUDIO_SetGainOut(dev,1);
                else if(i==2200)
                    MHAL_AUDIO_SetGainOut(dev,2);
                else if(i==2300)
                    MHAL_AUDIO_SetGainOut(dev,3);
                else if(i==2400)
                    MHAL_AUDIO_SetGainOut(dev,4);
                else if(i==2500)
                    MHAL_AUDIO_SetGainOut(dev,5);
                else if(i==2600)
                    MHAL_AUDIO_SetGainOut(dev,6);
                else if(i==2700)
                    MHAL_AUDIO_SetGainOut(dev,7);
                else if(i==2800)
                    MHAL_AUDIO_SetGainOut(dev,8);
                else if(i==2900)
                    MHAL_AUDIO_SetGainOut(dev,9);
                else if(i==3000)
                    MHAL_AUDIO_SetGainOut(dev,10);
#endif
                if(size>=(nStartThres) && flag==1)
                {
                    //AUD_PRINTF(ERROR_LEVEL, "MHAL_AUDIO_StartPcmOut b:%u p:%u!!!!!!!!!!\n",tPcm.u32BufferSize,tPcm.u32PeriodSize);
                    //AUD_PRINTF(ERROR_LEVEL, "MHAL_AUDIO_StartPcmOut %d!!!!!!!!!!\n",size);
                    printk(KERN_ERR"MHAL_AUDIO_StartPcmOut %d!!!!!!!!!!\n",size);
                    ret = MHAL_AUDIO_StartPcmOut(dev);
                    if(ret)
                    {
                        AUD_PRINTF(ERROR_LEVEL, "MHAL_AUDIO_StartPcmOut error=%d!!!\n",ret);
                        goto fail;
                    }

                    flag=0;
                }

                ret = MHAL_AUDIO_WriteDataOut(dev, pDataArray, nArrSize, TRUE);
                if(ret<0)
                {
                    AUD_PRINTF(ERROR_LEVEL, "%d - write data fail!!!, ret = %d\n",i,ret);
                }
                else
                {
                    size += nArrSize;
                    total_size -= nArrSize;
                }
                //AUD_PRINTF(ERROR_LEVEL, "%d - write %d bytes!!!, size %d!!!\n",i,nArrSize,size);

                if(MHAL_AUDIO_IsPcmOutXrun(dev))
                {
                    flag = 1;
                    size = 0;
                }
            }


            ret = MHAL_AUDIO_WriteDataOut(dev, pDataArray, total_size, TRUE);

            if(ret<0)
            {
                AUD_PRINTF(ERROR_LEVEL, "%d - write data fail!!!, ret = %d\n",i,ret);
            }
            else
            {
                total_size = 0;
            }

            if(flag==1 && size!=0)
            {
                AUD_PRINTF(ERROR_LEVEL, "while out MHAL_AUDIO_StartPcmOut %d!!!!!!!!!!\n",size);
                ret = MHAL_AUDIO_StartPcmOut(dev);
                if(ret)
                {
                    AUD_PRINTF(ERROR_LEVEL, "MHAL_AUDIO_StartPcmOut error=%d!!!\n",ret);
                    goto fail;
                }

            }

            while(!MHAL_AUDIO_IsPcmOutXrun(dev))
            {
                msleep(1);
            }

fail:
            ret = MHAL_AUDIO_StopPcmOut(dev);
            if(ret)
            {
                AUD_PRINTF(ERROR_LEVEL, "MHAL_AUDIO_StopPcmOut error=%d!!!\n",ret);
                //return -EFAULT;
            }
            ret = MHAL_AUDIO_ClosePcmOut(dev);
            if(ret)
            {
                AUD_PRINTF(ERROR_LEVEL, "MHAL_AUDIO_ClosePcmOut error=%d!!!\n",ret);
                return -EFAULT;
            }
            break;
        }


        default:
            AUD_PRINTF(ERROR_LEVEL,"Unknown IOCTL Command 0x%08X\n", cmd);
            return -ENOTTY;
    }
    return 0;
}

static int AudioOpen(struct inode *inode, struct file *filp)
{
    int ret = 0;
    struct pcm_data *pPcmData;
    AUD_PRINTF(TRACE_LEVEL, "%s\n", __FUNCTION__);
    pPcmData = kzalloc(sizeof(struct pcm_data), GFP_KERNEL);
    if (pPcmData == NULL)
    {
        ret =  -ENOMEM;
        goto out;
    }

    getDevAttr(iminor(inode),&pPcmData->playback,&pPcmData->dev_id);

    filp->private_data = pPcmData;

out:
    return ret;
}

static int AudioRelease(struct inode *inode, struct file *filp)
{
    AUD_PRINTF(TRACE_LEVEL, "%s\n", __FUNCTION__);
    if(filp->private_data)
        kfree(filp->private_data);

    filp->private_data = NULL;


    return 0;
}

#if 0
MHAL_AUDIO_PcmCfg_t tPcmC0D0p=
{
    .eRate = E_MHAL_AUDIO_RATE_48K;
    .eWidth = E_MHAL_AUDIO_BITWIDTH_16;
    .u16Channels = 2;
    .bInterleaved = 1;
    .
}
#endif

static long AudioIoctl(struct file *filp, unsigned int cmd, unsigned long arg)
{
    int err= 0;
    struct pcm_data *pPcmData = (struct pcm_data *)filp->private_data;
    AUD_PRINTF(TRACE_LEVEL, "%s 0x%x!\n",__FUNCTION__,cmd);
    // wrong cmds: return ENOTTY (inappropriate ioctl) before access_ok()
    if (_IOC_TYPE(cmd) != AUDIO_IOCTL_MAGIC) return -ENOTTY;
    if (_IOC_NR(cmd) > IOCTL_AUDIO_MAXNR) return -ENOTTY;

    if (_IOC_DIR(cmd) & _IOC_READ)
    {
        err = !access_ok(VERIFY_WRITE, (void __user *)arg, _IOC_SIZE(cmd));
    }
    else if (_IOC_DIR(cmd) & _IOC_WRITE)
    {
        err = !access_ok(VERIFY_READ, (void __user *)arg, _IOC_SIZE(cmd));
    }
    if (err)
    {
        return -EFAULT;
    }

    if(pPcmData->playback)
        err = AudioPlayIoctl(filp,cmd,arg);
    else
        err = AudioCapIoctl(filp,cmd,arg);

    //AUD_PRINTF(ERROR_LEVEL, "%s return err = %d!!!\n",__FUNCTION__,err);
    printk(KERN_ERR"%s return err = %d!!!\n",__FUNCTION__,err);
    return err;
}


static struct cdev gsAudioCdev =
{
    .kobj = {.name= "audio", },
    .owner = THIS_MODULE,
};

static dev_t gAudioDev;
struct class *gpAudioClass = NULL;

static struct file_operations sAudioFops =
{
    .open = AudioOpen,
    .release = AudioRelease,
    .unlocked_ioctl = AudioIoctl
};
#if 0
static ssize_t play_time_show(struct device *dev, struct device_attribute *attr, char *buf)
{
    char *str = buf;
    char *end = buf + PAGE_SIZE;

    str += scnprintf(str, end - str, "%llu\n",g_nPlayStartTime);

    return (str - buf);
}

DEVICE_ATTR(play_time, 0444, play_time_show, NULL);

static ssize_t cap_time_show(struct device *dev, struct device_attribute *attr, char *buf)
{
    char *str = buf;
    char *end = buf + PAGE_SIZE;

    str += scnprintf(str, end - str, "%llu\n",g_nCapStartTime);

    return (str - buf);
}

DEVICE_ATTR(cap_time, 0444, cap_time_show, NULL);
#endif

static int DrvAudioModuleProbe(struct platform_device *pdev)
{
    // struct resource *res;
    //struct device_node *dev_node;
    // struct platform_device *pdev;
    //unsigned int irq_id;
    char name[16];
    int size = 96*1024;//pcm_playback_hardware.buffer_bytes_max;
    int card = 0;
    AUD_PRINTF(TRACE_LEVEL, "%s\r\n", __FUNCTION__);
    MHAL_AUDIO_Init();
    /* dev_node = of_find_compatible_node(NULL, NULL, "mstar,audio");
     if (!dev_node) {
         if (!dev_node)
             return -ENODEV;
     }

     pdev = of_find_device_by_node(dev_node);
     if (!pdev) {
         of_node_put(dev_node);
         return -ENODEV;
     }

    irq_id = of_irq_to_resource(pdev->dev.of_node, 0, NULL);
    AUD_PRINTF(ERROR_LEVEL, "Platform get resource IORESOURCE_IRQ = 0x%x\n", irq_id);*/


    //getDevAttr(iminor(inode),&bPlay,&device);

    snprintf(name, 16, "pcmC%d", card);


    buf.area = alloc_dmem(name, PAGE_ALIGN(size),&buf.addr);

    if (!buf.area)
        return -ENOMEM;
    buf.bytes = PAGE_ALIGN(size);

    // buf.addr -= MIU_OFFSET;

    AUD_PRINTF(TRACE_LEVEL, "%s dma buffer size 0x%x\n",name, buf.bytes);
    AUD_PRINTF(TRACE_LEVEL, "physical dma address 0x%08x\n", buf.addr-MIU_OFFSET);
    AUD_PRINTF(TRACE_LEVEL, "virtual dma address 0x%08x\n", (unsigned int)buf.area);



    return 0;
}
static int DrvAudioModuleRemove(struct platform_device *pdev)
{
    char name[16];
    int card = 0;
    AUD_PRINTF(TRACE_LEVEL, "%s\r\n", __FUNCTION__);
    snprintf(name, 16, "pcmC%d", card);
    free_dmem(name, buf.bytes, buf.area, buf.addr);


    return 0;
}

static int DrvAudioModuleSuspend(struct platform_device *dev, pm_message_t state)
{
    int ret = 0;
    AUD_PRINTF(TRACE_LEVEL, "%s\r\n", __FUNCTION__);

    return ret;
}

static int DrvAudioModuleResume(struct platform_device *dev)
{
    int ret = 0;
    AUD_PRINTF(TRACE_LEVEL, "%s\r\n", __FUNCTION__);

    return ret;
}

static struct platform_driver stAudPlatformDriver =
{
    .probe      = DrvAudioModuleProbe,
    .remove     = DrvAudioModuleRemove,
    .suspend    = DrvAudioModuleSuspend,
    .resume     = DrvAudioModuleResume,
    .driver =
    {
        .name   = "ms-audio",
        .owner  = THIS_MODULE,
    },
};



static struct platform_device *pAudPlatformDev = NULL;
static int __init DrvAudioModuleInit(void)
{
    int ret = 0;
    int i;
    struct device *dev;
    int major;
    int minor = 0;
    int card = 0;
    char str[16];


    AUD_PRINTF(TRACE_LEVEL, "%s\r\n", __FUNCTION__);

    ret = alloc_chrdev_region(&gAudioDev, 0, AUDIO_DEV, "audio");
    if (ret)
    {
        AUD_PRINTF(ERROR_LEVEL,"can't alloc chrdev\n");
        return ret;
    }

    cdev_init(&gsAudioCdev, &sAudioFops);
    if (0 != (ret= cdev_add(&gsAudioCdev, gAudioDev, AUDIO_DEV)))
    {
        AUD_PRINTF(ERROR_LEVEL, "%s:Unable add a character device\n", __FUNCTION__);
        unregister_chrdev_region(gAudioDev, 1);
        return ret;
    }


    gpAudioClass = class_create(THIS_MODULE, "audio");
    if(IS_ERR(gpAudioClass))
    {
        AUD_PRINTF(ERROR_LEVEL, "%s:Failed at class_create().Please exec [mknod] before operate the device\n", __FUNCTION__);
    }
    else
    {
        major = MAJOR(gAudioDev);
        /* create capture device */
        for(i=0; i<AUDIO_IN_DEV; i++)
        {
            sprintf(str, "pcmC%iD%ic", card, i);
            dev = device_create(gpAudioClass, NULL, MKDEV(major,minor), NULL, str);
            if (IS_ERR(dev))
            {
                ret = PTR_ERR(dev);
                cdev_del(&gsAudioCdev);
                unregister_chrdev_region(gAudioDev, AUDIO_DEV);
            }
            minor++;
        }


        /* create playback device */
        for(i=0; i<AUDIO_OUT_DEV; i++)
        {
            sprintf(str, "pcmC%iD%ip", card, i);
            dev = device_create(gpAudioClass, NULL, MKDEV(major,minor), NULL, str);
            if (IS_ERR(dev))
            {
                ret = PTR_ERR(dev);
                cdev_del(&gsAudioCdev);
                unregister_chrdev_region(gAudioDev, AUDIO_DEV);
            }
            minor++;
        }
    }


    {
        /* ret = device_create_file(dev, &dev_attr_play_time);
         if(ret)
             AUD_PRINTF(ERROR_LEVEL, "%s:add attibute failed\n", __FUNCTION__);

         ret = device_create_file(dev, &dev_attr_cap_time);
         if(ret)
             AUD_PRINTF(ERROR_LEVEL, "%s:add attibute failed\n", __FUNCTION__);*/
    }

    pAudPlatformDev = platform_device_alloc("ms-audio", -1);
    if (!pAudPlatformDev)
    {
        AUD_PRINTF(ERROR_LEVEL, "%s: platform_device_alloc ms-audio error\r\n", __FUNCTION__);
        return -ENOMEM;
    }

    ret = platform_device_add(pAudPlatformDev);
    if (ret)
    {
        AUD_PRINTF(ERROR_LEVEL, "%s: platform_device_add infinity_snd_device error\r\n", __FUNCTION__);
        platform_device_put(pAudPlatformDev);
    }

    ret = platform_driver_register(&stAudPlatformDriver);
    if (ret)
    {
        AUD_PRINTF(ERROR_LEVEL, "%s: platform_driver_register voc_dma_driver error\r\n", __FUNCTION__);
        platform_device_unregister(pAudPlatformDev);
    }

    return ret;
}

static void __exit DrvAudioModuleExit(void)
{
    int i,major;

    AUD_PRINTF(TRACE_LEVEL, "%s\r\n", __FUNCTION__);
    major = MAJOR(gAudioDev);


    for(i=0; i<AUDIO_DEV; i++)
    {
        device_destroy(gpAudioClass,MKDEV(major,i));

    }

    class_destroy(gpAudioClass);

    cdev_del(&gsAudioCdev);

    unregister_chrdev_region(gAudioDev, AUDIO_DEV);
}

module_init(DrvAudioModuleInit);
module_exit(DrvAudioModuleExit);


MODULE_LICENSE("GPL");
